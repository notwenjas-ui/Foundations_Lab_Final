exports.id=729,exports.ids=[729],exports.modules={6114(e,i,t){t.d(i,{GkMcpProvider:()=>GkMcpProvider});var r=t(1398),o=t(4170),n=t(6240),s=t(8986),a=t(6607),c=t(1361),p=t(2055),d=t(6753),g=Object.defineProperty,l=Object.getOwnPropertyDescriptor,h=(e,i,t,r)=>{for(var o,n=r>1?void 0:r?l(i,t):i,s=e.length-1;s>=0;s--)(o=e[s])&&(n=(r?o(i,t,n):o(n))||n);return r&&n&&g(i,t,n),n};let m=/checking for updates.../i;let GkMcpProvider=class GkMcpProvider{constructor(e){this.container=e,this._disposable=r.Disposable.from(this.container.storage.onDidChange(e=>this.onStorageChanged(e)),this.container.events.on("gk:cli:ipc:started",()=>this.onIpcServerStarted()),r.lm.registerMcpServerDefinitionProvider("gitlens.gkMcpProvider",this)),this._ipcTimeoutId=setTimeout(()=>this.onIpcTimeoutExpired(),3e4)}_cliVersion;_disposable;_onDidChangeMcpServerDefinitions=new r.EventEmitter;_fireChangeDebounced=void 0;_getMcpConfigurationFromCLIPromise;_ipcTimeoutId;_hasProvidedDefinition=!1;_waitingForIPC=!0;get onDidChangeMcpServerDefinitions(){return this._onDidChangeMcpServerDefinitions.event}clearIpcTimeout(){this._waitingForIPC=!1,null!=this._ipcTimeoutId&&(clearTimeout(this._ipcTimeoutId),this._ipcTimeoutId=void 0)}dispose(){this.clearIpcTimeout(),this._disposable.dispose(),this._onDidChangeMcpServerDefinitions.dispose()}onStorageChanged(e){if("scoped"!==e.type||!e.keys.includes("gk:cli:install"))return;let i=this.container.storage.getScoped("gk:cli:install");i?.status==="completed"&&(this._cliVersion!==i?.version&&(this._getMcpConfigurationFromCLIPromise=void 0),this._cliVersion=i?.version,this._fireChangeDebounced??=(0,a.s)(()=>{this._onDidChangeMcpServerDefinitions.fire()},500),this._fireChangeDebounced())}onIpcServerStarted(){this.clearIpcTimeout(),this._fireChangeDebounced??=(0,a.s)(()=>{this._onDidChangeMcpServerDefinitions.fire()},500),this._fireChangeDebounced()}onIpcTimeoutExpired(){this.clearIpcTimeout(),this._hasProvidedDefinition||this._onDidChangeMcpServerDefinitions.fire()}async provideMcpServerDefinitions(){let{environmentVariableCollection:e}=this.container.context,i=e.get("GK_GL_PATH")?.value;if(null!=i)this.clearIpcTimeout();else if(this._waitingForIPC)return[];let t=await this.getMcpConfigurationFromCLI();if(null==t)return[];this._hasProvidedDefinition=!0;let o={};return null!=i&&(o.GK_GL_PATH=i),[new r.McpStdioServerDefinition(t.name,t.command,t.args,o,t.version)]}getMcpConfigurationFromCLI(){return this._getMcpConfigurationFromCLIPromise??=this.getMcpConfigurationFromCLICore(),this._getMcpConfigurationFromCLIPromise}async getMcpConfigurationFromCLICore(){let e=(0,p.dQ)(),i=this.container.storage.getScoped("gk:cli:install"),t=this.container.storage.getScoped("gk:cli:path");if(i?.status!=="completed"||!t)return;let s=(0,d.Sl)(await (0,n.d5)());if(null!=s)try{let e=["mcp","config",s,"--source=gitlens",`--scheme=${r.env.uriScheme}`];o.H.get("gitkraken.cli.insiders.enabled")&&e.push("--insiders");let n=await (0,d.XH)(e,{cwd:t});n=n.replace(m,"").trim();let a=JSON.parse(n);if(!a.type||!a.command||!Array.isArray(a.args))throw Error(`Invalid MCP configuration: missing required properties (${n})`);return this.onRegistrationCompleted(i.version),{name:a.name??"GitKraken",type:a.type,command:a.command,args:a.args,version:i.version}}catch(t){c.Vy.error(t,e,"Error getting MCP configuration"),this.onRegistrationFailed("Error getting MCP configuration",String(t),i.version)}}onRegistrationCompleted(e){this.container.telemetry.enabled&&this.container.telemetry.setGlobalAttribute("gk.mcp.registrationCompleted",!0)}onRegistrationFailed(e,i,t){this.container.telemetry.enabled&&this.container.telemetry.sendEvent("mcp/registration/failed",{reason:e,"error.message":i,source:"gk-mcp-provider","cli.version":t})}};h([(0,s.Rm)({exit:!0})],GkMcpProvider.prototype,"provideMcpServerDefinitions",1),h([(0,s.Rm)()],GkMcpProvider.prototype,"getMcpConfigurationFromCLI",1),h([(0,s.Yz)()],GkMcpProvider.prototype,"getMcpConfigurationFromCLICore",1)}};