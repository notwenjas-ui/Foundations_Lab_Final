exports.id=696,exports.ids=[696],exports.modules={809(e,t,i){i.d(t,{TimelineWebviewProvider:()=>TimelineWebviewProvider});var s=i(1398),o=i(9554),n=i(3783),r=i(699),a=i(751),h=i(2742),l=i(7067),c=i(5362),p=i(7106),u=i(4138),d=i(8256),g=i(3974),y=i(9361),v=i(1044),b=i(4529),f=i(1041),m=i(4713),w=i(4170),_=i(509),S=i(2977),C=i(7247),D=i(9841),T=i(8986),x=i(6607),P=i(7775),B=i(8298),R=i(8186),W=i(1396),A=i(6980),F=i(9653),O=i(4343),H=i(5162),M=i(1654),k=i(2126);let U="timeline",Y=new k.Oz(U,"ref/choose"),z=new k.Oz(U,"path/choose"),E=new k.Q2(U,"point/open"),I=new k.Q2(U,"config/update"),V=new k.Q2(U,"scope/update"),G=new k.C1(U,"didChange");var $=i(4380),L=Object.defineProperty,K=Object.getOwnPropertyDescriptor,Q=(e,t,i,s)=>{for(var o,n=s>1?void 0:s?K(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(n=(s?o(t,i,n):o(n))||n);return s&&n&&L(t,i,n),n};let TimelineWebviewProvider=class TimelineWebviewProvider{constructor(e,t){this.container=e,this.host=t,this._context={config:{period:"3|M",showAllBranches:!1,sliceBy:"author"},scope:void 0,etags:{repositories:this.container.git.etag,repository:void 0,repositoryWip:void 0,subscription:this.container.subscription.etag}},this.host.is("view")&&(this.host.description=o.lD)}_context;_disposable;_cache=new A.od({accessTTL:3e5});get activeTabUri(){return(0,C.ek)(s.window.tabGroups.activeTabGroup.activeTab)}dispose(){this._cache.clear(),this._disposable?.dispose()}canReuseInstance(...e){let t,[i]=e;if(null!=i)(0,$.ut)(i)?t=i:(0,M.c)(i)&&i.state.scope?.uri!=null&&(t=(0,$.Tf)(i.state.scope));else{let e=this.activeTabUri;null!=e&&(t={type:"file",uri:e})}return(0,$.Fp)(t,this._context.scope)}getSplitArgs(){return null!=this._context.scope?[this._context.scope]:[]}getTelemetryContext(){return{...this.host.getTelemetryContext(),"context.period":this._context.config.period,"context.scope.hasHead":this._context.scope?.head!=null,"context.scope.hasBase":this._context.scope?.base!=null,"context.scope.type":this._context.scope?.type,"context.showAllBranches":this._context.config.showAllBranches,"context.sliceBy":this._context.config.sliceBy}}async onShowing(e,t,...i){let o,[n]=i;if(null!=n&&((0,$.ut)(n)?o=n:(0,M.c)(n)&&null!=n.state.scope&&(this._context.config={...this._context.config,...n.state.config},this.host.is("editor")&&(o={type:n.state.scope.type,uri:s.Uri.parse(n.state.scope.uri),head:n.state.scope.head}))),null==o){let e=await (0,r.G)(this.container,this.activeTabUri);null!=e?o={type:"file",uri:e}:this.host.is("editor")&&null!=(e=this.container.git.getBestRepositoryOrFirst()?.uri)&&(o={type:"repo",uri:e})}let a=await this.updateScope(o,!0,!0);e||!a&&this.host.visible||this.updateState();let h=(0,B.Bq)(w.H.get("visualHistory"),"context.config",{joinArrays:!0});return[!0,{...this.getTelemetryContext(),...h}]}includeBootstrap(e){return this._cache.getOrCreate("bootstrap",()=>this.getState(this._context,!1))}registerCommands(){let e=[];return this.host.is("view")&&e.push((0,m.Lb)(`${this.host.id}.refresh`,()=>this.host.refresh(!0),this),(0,m.Lb)(`${this.host.id}.openInTab`,()=>{this._context.scope?.type==="file"&&((0,m.RS)("gitlens.visualizeHistory",this._context.scope),this.host.sendTelemetryEvent("timeline/action/openInEditor",{"scope.type":this._context.scope.type,"scope.hasHead":null!=this._context.scope.head,"scope.hasBase":null!=this._context.scope.base}))},this)),e}onActiveChanged(e){e&&this.fireFileSelected()}async onReady(){await this.updateScope(this._context.scope,!0),this.updateState(!0)}onRefresh(e){this._cache.clear()}async onVisibilityChanged(e){if(!e){this._disposable?.dispose(),this._repositorySubscription?.pause();return}if(this._repositorySubscription?.resume(),this.host.is("editor"))this._disposable=s.Disposable.from(this.container.subscription.onDidChange(this.onSubscriptionChanged,this));else{this._disposable=s.Disposable.from(this.container.subscription.onDidChange(this.onSubscriptionChanged,this),this.container.git.onDidChangeRepositories(this.onRepositoriesChanged,this),s.window.tabGroups.onDidChangeTabGroups(this.onTabsChanged,this),s.window.tabGroups.onDidChangeTabs(this.onTabsChanged,this),this.container.events.on("file:selected",(0,x.s)(this.onFileSelected,250),this));let e=await (0,r.G)(this.container,this.activeTabUri);this.updateScope(e?{type:"file",uri:e}:void 0)}}_openingDataPoint;_pendingOpenDataPoint;async onChoosePath(e){let{repoUri:t,ref:i,title:s,initialPath:o}=e,n=this.container.git.getRepository(t);if(null==n)return{picked:void 0};let r=await (0,f.G)(this.container,(0,d.kA)(i?.ref??"HEAD",n.path),{allowFolders:!0,initialPath:o,title:s});return{picked:null!=r?{type:r.type,relativePath:this.container.git.getRelativePath(r.uri,n.uri)}:void 0}}async onChooseRef(e){let{scope:t}=this._context;if(null==t||null==e.scope)return;let i=this.container.git.getRepository(e.scope.uri);if(null==i)return;(0,$.bt)(e.scope,t)||await this.updateScope((0,$.Tf)(e.scope));let s="base"===e.type?t.base:t.head,o=["branches","tags","HEAD"];i.virtual||this._context.config.showAllBranches||"base"===e.type||o.push("allBranches");let n=await (0,v.n)(i.path,"base"===e.type?"Choose a Base Reference":"Choose a Head Reference","base"===e.type?"Choose a reference (branch, tag, etc) as the base to view history from":"Choose a reference (branch, tag, etc) as the head to view history for",{allowedAdditionalInput:{rev:!0},picked:s?.ref,include:o,sort:!0});return n.directive===y.WL.RefsAllBranches?{type:e.type,ref:null}:null!=n.value?(n.value.ref,s=(0,l.of)(n.value),{type:e.type,ref:s}):void 0}async onSelectDataPoint(e){if(null!=e.scope&&null!=e.id){if(this._openingDataPoint){this._pendingOpenDataPoint=e;return}this._openingDataPoint=e;try{await this.openDataPoint(e)}finally{let e=this._openingDataPoint;if(this._openingDataPoint=void 0,this._pendingOpenDataPoint){let t=this._pendingOpenDataPoint;this._pendingOpenDataPoint=void 0,(t.id!==e?.id||t.shift!==e?.shift)&&this.openDataPoint(t)}}}}onUpdateConfig(e){let{config:t}=this._context,i=!1,{changes:s}=e;null!=s.period&&s.period!==t.period&&(i=!0,t.period=s.period),null!=s.showAllBranches&&s.showAllBranches!==t.showAllBranches&&(i=!0,t.showAllBranches=s.showAllBranches,"branch"!==t.sliceBy||t.showAllBranches||(t.sliceBy="author")),null!=s.sliceBy&&s.sliceBy!==t.sliceBy&&(i=!0,t.sliceBy=s.sliceBy,"branch"!==t.sliceBy||t.showAllBranches||(t.showAllBranches=!0)),i&&(this.host.sendTelemetryEvent("timeline/config/changed",{period:t.period,showAllBranches:t.showAllBranches,sliceBy:t.sliceBy}),this._cache.clear(),this.updateState(!0))}async onUpdateScopeHandler(e){if(null==e.scope)return;let t=this.container.git.getRepository(e.scope.uri);if(null==t)return;let i=(0,$.Tf)(e.scope),{changes:{type:s,head:o,base:n,relativePath:r}}=e,a=!1;if(null!=s&&s!==i.type)a=!0,i.type=s,"repo"===s&&(i.uri=t.uri);else if("repo"===s&&"repo"===i.type){let{title:e,placeholder:s}=(0,b.Nt)(this.container.git.openRepositories,"Switch",t?.name),o=await (0,b.Ab)(this.container,e,s,this.container.git.openRepositories,{picked:t});null==o.value||(0,O.A)(o.value.uri,i.uri)||(t=o.value,a=!0,i.uri=o.value.uri,i.head=void 0,i.base=void 0)}if(void 0!==o&&(a=!0,i.head=o??void 0),void 0!==n&&(a=!0,i.base=n??void 0),null!=r&&(a=!0,i.uri=this.container.git.getAbsoluteUri(r,t.uri)),this.host.is("view")||e.altOrShift){(0,m.RS)("gitlens.visualizeHistory",i),this.host.sendTelemetryEvent("timeline/action/openInEditor",{"scope.type":i.type,"scope.hasHead":null!=i.head,"scope.hasBase":null!=i.base});return}a&&this.updateScope(i)}_tabCloseDebounceTimer;async onTabsChanged(e){null!=this._tabCloseDebounceTimer&&(clearTimeout(this._tabCloseDebounceTimer),this._tabCloseDebounceTimer=void 0);let t=await (0,r.G)(this.container,this.activeTabUri);if(null==t){this._tabCloseDebounceTimer=setTimeout(async()=>{this._tabCloseDebounceTimer=void 0,await this.updateScope(t,void 0,!0)&&this.host.sendTelemetryEvent("timeline/editor/changed")},1e3);return}await this.updateScope(t?{type:"file",uri:t}:void 0,void 0,!0)&&this.host.sendTelemetryEvent("timeline/editor/changed")}async onFileSelected(e){if(null==e.data)return;let t=e.data.uri;null==t||this.container.git.isTrackable(t)||(t=void 0),t=await (0,r.G)(this.container,t??this.activeTabUri),await this.updateScope(t?{type:"file",uri:t}:void 0,void 0,!0)&&this.host.sendTelemetryEvent("timeline/editor/changed")}fireFileSelected(){this._context.scope?.type==="file"&&this.host.is("editor")&&this.container.events.fire("file:selected",{uri:this._context.scope.uri,preserveFocus:!0,preserveVisibility:!1},{source:this.host.id})}onRepositoriesChanged(e){this._context.etags.repositories!==e.etag&&this.updateScope(this._context.scope)}onRepositoryChanged(e){e.changed(a.Z_.Heads,a.Z_.Index,a.Ti.Any)&&this._context.etags.repository!==e.repository.etag&&this.updateScope(this._context.scope)}onRepositoryWipChanged(e){if(e.repository.id!==this._repositorySubscription?.source?.id||this._context.etags.repositoryWip===e.repository.etagFileSystem)return;let t=this._context.scope?.uri;null!=t&&(e.uris.has(t)||(0,P.zN)(e.uris,e=>(0,_.K9)(e,t)))?this.updateScope(this._context.scope):this._context.etags.repositoryWip=e.repository.etagFileSystem}onSubscriptionChanged(e){this._context.etags.subscription!==e.etag&&this.updateScope(this._context.scope)}async getState(e,t){let i=w.H.get("defaultDateFormat")??"MMMM Do, YYYY h:mma",s=w.H.get("defaultDateShortFormat")??"short",{git:o}=this.container,{scope:n}=e,r={...e.config,abbreviatedShaLength:this.container.CommitShaFormatting.length,dateFormat:i,shortDateFormat:s};o.isDiscoveringRepositories&&await o.isDiscoveringRepositories;let a=n?.uri!=null?o.getRepository(n.uri)??await o.getOrOpenRepository(n.uri,{closeOnOpen:!0}):void 0,h=await o.access("timeline",a?.uri);if(null==n||null==a)return{...this.host.baseWebviewState,dataset:void 0,config:r,scope:void 0,repository:void 0,repositories:{count:0,openCount:0},access:h};let{uri:p}=n,u=o.getRelativePath(p,a.uri),d=(0,l.of)(await a.git.branches.getBranch()),g=null!=a?{...(0,c.Pv)(a),ref:d}:void 0;return n.head??=d,null==n.base&&(n.base??=n.head),{...this.host.baseWebviewState,dataset:t?this.getDataset(n,a,e.config,h):void 0,config:r,scope:(0,$.E_)(n,u),repository:g,repositories:{count:this.container.git.repositoryCount,openCount:this.container.git.openRepositoryCount},access:h}}async getDataset(e,t,i,s){let o;if(!1===s.allowed)return function(e){let t=[],i=["Eric Amodio","Justin Roberts","Keith Daulton","Ramin Tadayon","Ada Lovelace","Grace Hopper"];for(let s=0;s<10;s++){let o=new Date(Date.now()-Math.floor(7776e6*Math.random())),n=i[Math.floor(Math.random()*i.length)],r=0===s?2:9===s?50:Math.floor(20*Math.random())+1,a=0===s?1:9===s?25:Math.floor(20*Math.random())+1;t.push({sha:Math.random().toString(16).substring(2,10),author:n,date:o.toISOString(),message:`Commit message for changes by ${n}`,files:"file"===e?void 0:Math.floor(Math.random()*(r+a))+1,additions:r,deletions:a,sort:o.getTime()})}return t.sort((e,t)=>t.sort-e.sort)}(e.type);i.showAllBranches||((o=e.head?.ref)?e.base?.ref!=null&&e.base?.ref!==o&&(o=(0,g.Xn)(o,e.base?.ref,"..")):o=e.base?.ref);let[n,r,a]=await Promise.allSettled([t.git.contributors.getContributors(o,{all:i.showAllBranches,pathspec:"repo"===e.type?void 0:e.uri.fsPath,since:(function(e){let t;if("all"===e)return;let[i,s]=e.split("|");switch(s){case"D":t=(0,D.Tl)(new Date,{days:-parseInt(i,10)});break;case"M":t=(0,D.Tl)(new Date,{months:-parseInt(i,10)});break;case"Y":t=(0,D.Tl)(new Date,{years:-parseInt(i,10)});break;default:t=(0,D.Tl)(new Date,{months:-3})}return t.getHours()>=12&&t.setDate(t.getDate()+1),t.setHours(0,0,0,0),t})(i.period)?.toISOString(),stats:!0}),t.virtual?void 0:"repo"!==e.type?t.git.status.getStatusForPath?.(e.uri,{renames:"file"===e.type}):t.git.status.getStatus().then(e=>e?.files),t.git.config.getCurrentUser()]),h=(0,W.Ro)(a),l=h?.name?`${h.name} (you)`:"You",c=[],d=(0,W.Ro)(n);if(null!=d){for(let e of d.contributors)if(null!=e.contributions)for(let t of e.contributions)c.push({author:e.current?l:e.name,sha:t.sha,date:t.date.toISOString(),message:t.message,files:t.files,additions:t.additions,deletions:t.deletions,sort:t.date.getTime()})}if(i.showAllBranches&&"branch"===i.sliceBy&&"repo"!==e.type&&!t.virtual){let i=new Set(await t.git.commits.getLogShas?.(`^${e.head?.ref??"HEAD"}`,{all:!0,pathOrUri:e.uri,limit:0})),s=c.filter(e=>i.has(e.sha));await (0,W.vA)(s,10,async e=>{e.branches=await t.git.branches.getBranchesWithCommits([e.sha],void 0,{all:!0,mode:"contains"})})}let y=(0,W.Ro)(r),v=this.container.git.getRelativePath(e.uri,t.uri),b=await (0,p.S)(this.container,y,v,h);return b?.length?c.splice(0,0,...(0,P.Tj)(b,t=>{var i,s,o,n;let r,a,h,c;return i=t,s=e.type,o=l,null!=(c=(n=i,"file"===s?n.file?.stats??(1===(0,u.Zx)(n.stats?.files)?n.stats:void 0):n.stats))&&({additions:r,deletions:a}=c),"file"===s?h=void 0:null!=i.stats&&(h=(0,u.Zx)(i.stats.files)),{author:"You"===i.author.name?o:i.author.name,files:h,additions:r,deletions:a,sha:i.sha,date:i.date.toISOString(),message:i.message??i.summary,sort:i.date.getTime()}})):c.length&&c.splice(0,0,{author:c[0].author,files:0,additions:0,deletions:0,sha:"",date:new Date().toISOString(),message:"Working Tree",sort:Date.now()}),c.sort((e,t)=>t.sort-e.sort),c}async openDataPoint(e){if(null==e.scope)return;let t=this.container.git.getRepository(e.scope.uri);if(null==t)return;this.host.sendTelemetryEvent("timeline/commit/selected");let i=await t.git.commits.getCommit(e.id||h.SU);if(null==i)return;function o(e,t){return(0,g._k)(t)?(0,g.KH)(t)?t=>!!t.staged&&(0,_.K9)(t.uri,e):t=>!t.staged&&(0,_.K9)(t.uri,e):t=>(0,_.K9)(t.uri,e)}i.hasFullDetails()||await i.ensureFullDetails({include:{uncommittedFiles:!0}}),this.container.events.fire("commit:selected",{commit:i,interaction:"active",preserveFocus:!0,preserveVisibility:!1},{source:this.host.id});let{type:r,uri:a}=(0,$.Tf)(e.scope);switch(r){case"folder":case"repo":e.shift?await (0,n.Qv)(this.container,i,!1,{preserveFocus:!0,preview:!0,sourceViewColumn:this.host.viewColumn,viewColumn:this.host.is("view")?void 0:s.ViewColumn.Beside,title:`Folder Changes in ${(0,g.pV)(i.sha,{strings:{working:"Working Tree"}})}`},"folder"===r?o(a,i.sha):void 0):await (0,n.P3)(this.container,i,!1,{preserveFocus:!0,preview:!0,sourceViewColumn:this.host.viewColumn,viewColumn:this.host.is("view")?void 0:s.ViewColumn.Beside,title:`Folder Changes in ${(0,g.pV)(i.sha,{strings:{working:"Working Tree"}})}`},"folder"===r?o(a,i.sha):void 0);break;case"file":if(i.isUncommitted&&!i.isUncommittedStaged&&!i.anyFiles?.some(e=>e.uri.fsPath===a.fsPath)){(0,S.zu)(a,{preserveFocus:!0,preview:!0,viewColumn:this.host.is("view")?void 0:s.ViewColumn.Beside});break}e.shift?await (0,n.DD)(a,i,{preserveFocus:!0,preview:!0,viewColumn:this.host.is("view")?void 0:s.ViewColumn.Beside}):await (0,n.eX)(a,i,{preserveFocus:!0,preview:!0,viewColumn:this.host.is("view")?void 0:s.ViewColumn.Beside})}}_repositorySubscription;async updateScope(e,t,i){var s,n;null!=this._tabCloseDebounceTimer&&(clearTimeout(this._tabCloseDebounceTimer),this._tabCloseDebounceTimer=void 0);let r={repositories:this.container.git.etag,repository:void 0,repositoryWip:void 0,subscription:this.container.subscription.etag},a="";if(null!=e){this.container.git.isDiscoveringRepositories&&await this.container.git.isDiscoveringRepositories;let t=this.container.git.getRepository(e.uri);this._repositorySubscription?.source!==t&&(this._repositorySubscription?.dispose(),this._repositorySubscription=void 0),null!=t&&((0,O.A)(e.uri,t.uri)&&(e.type="repo",e.head??=(0,l.of)(await t.git.branches.getBranch())),this._repositorySubscription??=new F.v(t,e=>this.subscribeToRepository(e)),"file"===e.type||"folder"===e.type?(a=(0,R.P8)(this.container.git.getRelativePath(e.uri,t.uri)),e.head&&(a+=` (${e.head.ref})`),this.container.git.repositoryCount>1&&(a+=` \u2022 ${t.name}`)):e.head?(a+=e.head.name,this.container.git.repositoryCount>1&&(a+=` \u2022 ${t.name}`)):a=t.name),r.repository=t?.etag??0,r.repositoryWip=t?.etagFileSystem??0}else this._repositorySubscription?.dispose(),this._repositorySubscription=void 0,r.repository=0,r.repositoryWip=0;return this.host.visible&&this._repositorySubscription?.start(),s=this._context.etags,n=r,!(s.repositories===n.repositories&&s.repository===n.repository&&s.repositoryWip===n.repositoryWip&&s.subscription===n.subscription&&(i?(0,$.Fp)(e,this._context.scope):(0,$.bt)(e,this._context.scope)))&&(this._cache.clear(),this._context.scope=e,this._context.etags=r,this.host.is("editor")?this.host.title=a||"Visual History":this.host.description=a||o.lD,this.fireFileSelected(),this.host.sendTelemetryEvent("timeline/scope/changed"),t||this.updateState(),!0)}subscribeToRepository(e){return s.Disposable.from(e.watchFileSystem(1e3),e.onDidChangeFileSystem(this.onRepositoryWipChanged,this),e.onDidChange(this.onRepositoryChanged,this))}_notifyDidChangeStateDebounced=void 0;updateState(e=!1){e?this.notifyDidChangeState():(this._notifyDidChangeStateDebounced??=(0,x.s)(this.notifyDidChangeState.bind(this),500),this._notifyDidChangeStateDebounced())}async notifyDidChangeState(){this._notifyDidChangeStateDebounced?.cancel();let e=await this._cache.getOrCreate("state",()=>this.getState(this._context,!0));return this.host.notify(G,{state:e})}};Q([(0,H.YQ)(z)],TimelineWebviewProvider.prototype,"onChoosePath",1),Q([(0,H.YQ)(Y)],TimelineWebviewProvider.prototype,"onChooseRef",1),Q([(0,H.a1)(E)],TimelineWebviewProvider.prototype,"onSelectDataPoint",1),Q([(0,H.a1)(I)],TimelineWebviewProvider.prototype,"onUpdateConfig",1),Q([(0,H.a1)(V)],TimelineWebviewProvider.prototype,"onUpdateScopeHandler",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onTabsChanged",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onFileSelected",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onRepositoriesChanged",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onRepositoryChanged",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onRepositoryWipChanged",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onSubscriptionChanged",1),Q([(0,T.Yz)({args:!1})],TimelineWebviewProvider.prototype,"getState",1),Q([(0,T.Yz)()],TimelineWebviewProvider.prototype,"updateState",1),Q([(0,T.Yz)()],TimelineWebviewProvider.prototype,"notifyDidChangeState",1)},9653(e,t,i){i.d(t,{v:()=>SubscriptionManager});let SubscriptionManager=class SubscriptionManager{constructor(e,t){this.source=e,this.subscribe=t}_status="stopped";get status(){return this._status}_subscription;dispose(){this.stop()}start(){(null==this._subscription||"started"!==this._status)&&(this._subscription=this.subscribe(this.source),this._status="started")}pause(){this.stop("paused")}resume(){this.start()}stop(e){this._subscription?.dispose(),this._subscription=void 0,this._status=e??"stopped"}}}};